// docs/frontend/index.md - å‰ç«¯å¼€å‘åˆ†ç±»é¦–é¡µ
---
title: å‰ç«¯å¼€å‘
description: æ¢ç´¢ç°ä»£å‰ç«¯æŠ€æœ¯çš„æ— é™å¯èƒ½
---

# å‰ç«¯å¼€å‘

æ¬¢è¿æ¥åˆ°å‰ç«¯å¼€å‘ä¸“åŒºï¼è¿™é‡Œæ±‡é›†äº† HTML/CSSã€JavaScriptã€Vueã€React ç­‰ç°ä»£å‰ç«¯æŠ€æœ¯çš„æ·±åº¦åˆ†äº«å’Œå®è·µç»éªŒã€‚

## ğŸ“š æ–‡ç« åˆ†ç±»

### HTML/CSS
- ç°ä»£ CSS ç‰¹æ€§è¯¦è§£
- Flexbox å’Œ Grid å¸ƒå±€å®æˆ˜
- CSS åŠ¨ç”»å’Œè¿‡æ¸¡æ•ˆæœ
- å“åº”å¼è®¾è®¡æœ€ä½³å®è·µ

### JavaScript
- ES6+ æ–°ç‰¹æ€§æ·±åº¦è§£æ
- å¼‚æ­¥ç¼–ç¨‹ï¼šPromiseã€async/await
- JavaScript è®¾è®¡æ¨¡å¼
- æ€§èƒ½ä¼˜åŒ–æŠ€å·§

### Vue.js
- Vue 3 Composition API å®Œå…¨æŒ‡å—
- Vue Router å’Œ Vuex çŠ¶æ€ç®¡ç†
- Vue ç»„ä»¶è®¾è®¡åŸåˆ™
- Vue é¡¹ç›®å·¥ç¨‹åŒ–å®è·µ

### React
- React Hooks æ·±åº¦è§£æ
- React æ€§èƒ½ä¼˜åŒ–ç­–ç•¥
- Redux çŠ¶æ€ç®¡ç†æœ€ä½³å®è·µ
- React æœåŠ¡ç«¯æ¸²æŸ“ (SSR)

---

// docs/frontend/vue/vue3-composition-api.md - Vue 3 ç¤ºä¾‹æ–‡ç« 
---
title: Vue 3 Composition API æ·±åº¦è§£æ
date: 2024-01-15
author: Virginia
category: frontend
tags: [Vue3, Composition API, JavaScript]
description: æ·±å…¥äº†è§£ Vue 3 Composition API çš„è®¾è®¡ç†å¿µã€æ ¸å¿ƒç‰¹æ€§ä»¥åŠåœ¨å®é™…é¡¹ç›®ä¸­çš„åº”ç”¨å®è·µ
---

# Vue 3 Composition API æ·±åº¦è§£æ

Vue 3 çš„ Composition API æ˜¯ä¸€ä¸ªé‡è¦çš„ç‰¹æ€§ï¼Œå®ƒä¸ºç»„ä»¶é€»è¾‘ç»„ç»‡æä¾›äº†å…¨æ–°çš„æ–¹å¼ã€‚æœ¬æ–‡å°†æ·±å…¥æ¢è®¨å…¶è®¾è®¡ç†å¿µã€æ ¸å¿ƒç‰¹æ€§ä»¥åŠå®é™…åº”ç”¨ã€‚

## ğŸ¯ ä¸ºä»€ä¹ˆéœ€è¦ Composition APIï¼Ÿ

### ä¼ ç»Ÿ Options API çš„å±€é™æ€§

åœ¨ Vue 2 ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ Options API æ¥ç»„ç»‡ç»„ä»¶é€»è¾‘ï¼š

```vue
<template>
  <div>
    <p>Count: {{ count }}</p>
    <button @click="increment">+</button>
    <button @click="decrement">-</button>
  </div>
</template>

<script>
export default {
  data() {
    return {
      count: 0
    }
  },
  methods: {
    increment() {
      this.count++
    },
    decrement() {
      this.count--
    }
  }
}
</script>
```

è™½ç„¶è¿™ç§æ–¹å¼ç®€å•ç›´è§‚ï¼Œä½†éšç€ç»„ä»¶å¤æ‚åº¦å¢åŠ ï¼Œä¼šé‡åˆ°ä»¥ä¸‹é—®é¢˜ï¼š

1. **é€»è¾‘åˆ†æ•£**ï¼šç›¸å…³é€»è¾‘åˆ†å¸ƒåœ¨ä¸åŒçš„é€‰é¡¹ä¸­
2. **å¤ç”¨å›°éš¾**ï¼šé€»è¾‘å¤ç”¨ä¸»è¦ä¾èµ– mixinsï¼Œå®¹æ˜“äº§ç”Ÿå‘½åå†²çª
3. **ç±»å‹æ¨æ–­**ï¼šTypeScript æ”¯æŒä¸å¤Ÿå‹å¥½

### Composition API çš„ä¼˜åŠ¿

Composition API è§£å†³äº†è¿™äº›é—®é¢˜ï¼š

```vue
<template>
  <div>
    <p>Count: {{ count }}</p>
    <button @click="increment">+</button>
    <button @click="decrement">-</button>
  </div>
</template>

<script setup>
import { ref } from 'vue'

const count = ref(0)

const increment = () => {
  count.value++
}

const decrement = () => {
  count.value--
}
</script>
```

## ğŸš€ æ ¸å¿ƒ API è¯¦è§£

### 1. reactive å’Œ ref

```js
import { reactive, ref } from 'vue'

// ä½¿ç”¨ reactive å¤„ç†å¯¹è±¡
const state = reactive({
  count: 0,
  name: 'Virginia'
})

// ä½¿ç”¨ ref å¤„ç†åŸºæœ¬ç±»å‹
const count = ref(0)
const name = ref('Virginia')

// è®¿é—® ref çš„å€¼éœ€è¦ä½¿ç”¨ .value
console.log(count.value) // 0
count.value++
```

### 2. computed è®¡ç®—å±æ€§

```js
import { ref, computed } from 'vue'

const count = ref(1)
const doubleCount = computed(() => count.value * 2)

// å¸¦æœ‰ getter å’Œ setter çš„è®¡ç®—å±æ€§
const fullName = computed({
  get() {
    return `${firstName.value} ${lastName.value}`
  },
  set(value) {
    [firstName.value, lastName.value] = value.split(' ')
  }
})
```

### 3. watch å’Œ watchEffect

```js
import { ref, watch, watchEffect } from 'vue'

const count = ref(0)
const name = ref('Virginia')

// ä¾¦å¬å•ä¸ªæ•°æ®æº
watch(count, (newVal, oldVal) => {
  console.log(`count changed from ${oldVal} to ${newVal}`)
})

// ä¾¦å¬å¤šä¸ªæ•°æ®æº
watch([count, name], ([newCount, newName], [oldCount, oldName]) => {
  console.log('Multiple values changed')
})

// watchEffect è‡ªåŠ¨æ”¶é›†ä¾èµ–
watchEffect(() => {
  console.log(`Count is ${count.value}`)
})
```

## ğŸ› ï¸ å®é™…åº”ç”¨åœºæ™¯

### 1. é€»è¾‘ç»„åˆ

```js
// composables/useCounter.js
import { ref } from 'vue'

export function useCounter(initialValue = 0) {
  const count = ref(initialValue)
  
  const increment = () => count.value++
  const decrement = () => count.value--
  const reset = () => count.value = initialValue
  
  return {
    count,
    increment,
    decrement,
    reset
  }
}

// åœ¨ç»„ä»¶ä¸­ä½¿ç”¨
<script setup>
import { useCounter } from '@/composables/useCounter'

const { count, increment, decrement, reset } = useCounter(10)
</script>
```

### 2. ç”Ÿå‘½å‘¨æœŸé’©å­

```js
import { onMounted, onUnmounted, ref } from 'vue'

export function useMousePosition() {
  const x = ref(0)
  const y = ref(0)
  
  const updateMouse = (event) => {
    x.value = event.clientX
    y.value = event.clientY
  }
  
  onMounted(() => {
    window.addEventListener('mousemove', updateMouse)
  })
  
  onUnmounted(() => {
    window.removeEventListener('mousemove', updateMouse)
  })
  
  return { x, y }
}
```

### 3. å¼‚æ­¥æ•°æ®è·å–

```js
// composables/useApi.js
import { ref, toRefs } from 'vue'

export function useApi(url) {
  const data = ref(null)
  const loading = ref(false)
  const error = ref(null)
  
  const fetchData = async () => {
    loading.value = true
    error.value = null
    
    try {
      const response = await fetch(url)
      data.value = await response.json()
    } catch (err) {
      error.value = err.message
    } finally {
      loading.value = false
    }
  }
  
  return {
    data,
    loading,
    error,
    fetchData
  }
}
```

## ğŸ¨ æœ€ä½³å®è·µ

### 1. åˆç†ä½¿ç”¨ ref å’Œ reactive

```js
// âœ… å¥½çš„åšæ³•
const count = ref(0)              // åŸºæœ¬ç±»å‹ä½¿ç”¨ ref
const user = reactive({           // å¯¹è±¡ä½¿ç”¨ reactive
  name: 'Virginia',
  age: 25
})

// âŒ é¿å…çš„åšæ³•
const count = reactive({ value: 0 })  // ä¸è¦ä¸ºåŸºæœ¬ç±»å‹ä½¿ç”¨ reactive
```

### 2. ç»„åˆå‡½æ•°å‘½åè§„èŒƒ

```js
// âœ… ä½¿ç”¨ use å‰ç¼€
export function useCounter() {}
export function useMousePosition() {}
export function useApi() {}

// âŒ é¿å…çš„å‘½å
export function counter() {}
export function getMousePosition() {}
```

### 3. è¿”å›å€¼ç»“æ„

```js
// âœ… è¿”å›å¯¹è±¡ï¼Œä¾¿äºæŒ‰éœ€è§£æ„
export function useCounter() {
  return {
    count,
    increment,
    decrement
  }
}

// ä½¿ç”¨æ—¶
const { count, increment } = useCounter()

// âœ… ä¹Ÿå¯ä»¥è¿”å›æ•°ç»„ï¼Œé€‚åˆéœ€è¦é‡å‘½åçš„åœºæ™¯
export function useToggle(initialValue = false) {
  const state = ref(initialValue)
  const toggle = () => state.value = !state.value
  
  return [state, toggle]
}

// ä½¿ç”¨æ—¶
const [isVisible, toggleVisible] = useToggle()
```

## ğŸ”„ ä¸ Options API å¯¹æ¯”

| ç‰¹æ€§ | Options API | Composition API |
|------|-------------|-----------------|
| å­¦ä¹ æ›²çº¿ | è¾ƒå¹³ç¼“ | ç¨é™¡å³­ |
| ä»£ç ç»„ç»‡ | æŒ‰é€‰é¡¹åˆ†ç»„ | æŒ‰é€»è¾‘åˆ†ç»„ |
| é€»è¾‘å¤ç”¨ | mixins | ç»„åˆå‡½æ•° |
| TypeScript | ä¸€èˆ¬ | ä¼˜ç§€ |
| æ‰“åŒ…ä½“ç§¯ | è¾ƒå¤§ | è¾ƒå°ï¼ˆtree-shakingï¼‰ |

## ğŸ“ æ€»ç»“

Composition API ä¸º Vue 3 å¸¦æ¥äº†æ›´å¼ºå¤§çš„é€»è¾‘ç»„ç»‡èƒ½åŠ›ï¼Œç‰¹åˆ«é€‚åˆä»¥ä¸‹åœºæ™¯ï¼š

1. **å¤æ‚ç»„ä»¶**ï¼šé€»è¾‘è¾ƒå¤šï¼Œéœ€è¦æ›´å¥½çš„ç»„ç»‡æ–¹å¼
2. **é€»è¾‘å¤ç”¨**ï¼šå¤šä¸ªç»„ä»¶é—´éœ€è¦å…±äº«é€»è¾‘
3. **TypeScript é¡¹ç›®**ï¼šéœ€è¦æ›´å¥½çš„ç±»å‹æ¨æ–­
4. **å¤§å‹é¡¹ç›®**ï¼šéœ€è¦æ›´å¥½çš„å¯ç»´æŠ¤æ€§

è™½ç„¶å­¦ä¹ æˆæœ¬ç¨é«˜ï¼Œä½†é•¿è¿œæ¥çœ‹ï¼ŒComposition API èƒ½å¤Ÿå¸®åŠ©æˆ‘ä»¬æ„å»ºæ›´å¥å£®ã€æ›´æ˜“ç»´æŠ¤çš„ Vue åº”ç”¨ã€‚

---

*æœ¬æ–‡æ¶µç›–äº† Vue 3 Composition API çš„æ ¸å¿ƒæ¦‚å¿µå’Œå®è·µæŠ€å·§ï¼Œå¸Œæœ›å¯¹ä½ çš„ Vue å­¦ä¹ ä¹‹è·¯æœ‰æ‰€å¸®åŠ©ï¼*

---

// docs/backend/nodejs/express-middleware.md - Express ä¸­é—´ä»¶ç¤ºä¾‹æ–‡ç« 
---
title: Express ä¸­é—´ä»¶æœºåˆ¶æ·±åº¦å‰–æ
date: 2024-01-12
author: Virginia
category: backend
tags: [Node.js, Express, ä¸­é—´ä»¶]
description: å…¨é¢è§£æ Express.js ä¸­é—´ä»¶çš„å·¥ä½œåŸç†ï¼Œä»æºç è§’åº¦ç†è§£è¯·æ±‚å¤„ç†æµç¨‹
---

# Express ä¸­é—´ä»¶æœºåˆ¶æ·±åº¦å‰–æ

Express.js çš„ä¸­é—´ä»¶æœºåˆ¶æ˜¯å…¶æ ¸å¿ƒç‰¹æ€§ä¹‹ä¸€ï¼Œç†è§£ä¸­é—´ä»¶çš„å·¥ä½œåŸç†å¯¹äºæ„å»ºé«˜è´¨é‡çš„ Node.js åº”ç”¨è‡³å…³é‡è¦ã€‚

## ğŸ¤” ä»€ä¹ˆæ˜¯ä¸­é—´ä»¶ï¼Ÿ

ä¸­é—´ä»¶ï¼ˆMiddlewareï¼‰æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒå¯ä»¥è®¿é—®è¯·æ±‚å¯¹è±¡ï¼ˆreqï¼‰ã€å“åº”å¯¹è±¡ï¼ˆresï¼‰ä»¥åŠåº”ç”¨ç¨‹åºè¯·æ±‚-å“åº”å¾ªç¯ä¸­çš„ä¸‹ä¸€ä¸ªä¸­é—´ä»¶å‡½æ•°ï¼ˆnextï¼‰ã€‚

```js
const middleware = (req, res, next) => {
  // ä¸­é—´ä»¶é€»è¾‘
  console.log('Middleware executed')
  next() // è°ƒç”¨ä¸‹ä¸€ä¸ªä¸­é—´ä»¶
}

app.use(middleware)
```

## ğŸ”„ ä¸­é—´ä»¶æ‰§è¡Œæµç¨‹

Express ä¸­é—´ä»¶æŒ‰ç…§æ³¨å†Œé¡ºåºä¾æ¬¡æ‰§è¡Œï¼Œå½¢æˆä¸€ä¸ªç®¡é“ï¼š

```js
const express = require('express')
const app = express()

// ä¸­é—´ä»¶ 1
app.use((req, res, next) => {
  console.log('Middleware 1 - Before')
  next()
  console.log('Middleware 1 - After')
})

// ä¸­é—´ä»¶ 2
app.use((req, res, next) => {
  console.log('Middleware 2 - Before')
  next()
  console.log('Middleware 2 - After')
})

// è·¯ç”±å¤„ç†å™¨
app.get('/', (req, res) => {
  console.log('Route handler')
  res.send('Hello World')
})

// è¾“å‡ºé¡ºåºï¼š
// Middleware 1 - Before
// Middleware 2 - Before
// Route handler
// Middleware 2 - After
// Middleware 1 - After
```

## ğŸ“š ä¸­é—´ä»¶ç±»å‹

### 1. åº”ç”¨çº§ä¸­é—´ä»¶

```js
// åº”ç”¨äºæ‰€æœ‰è·¯ç”±
app.use((req, res, next) => {
  console.log('Time:', Date.now())
  next()
})

// åº”ç”¨äºç‰¹å®šè·¯å¾„
app.use('/user/:id', (req, res, next) => {
  console.log('Request Type:', req.method)
  next()
})
```

### 2. è·¯ç”±çº§ä¸­é—´ä»¶

```js
const router = express.Router()

router.use((req, res, next) => {
  console.log('Router middleware')
  next()
})

router.get('/profile', (req, res) => {
  res.send('User profile')
})

app.use('/user', router)
```

### 3. é”™è¯¯å¤„ç†ä¸­é—´ä»¶

```js
// é”™è¯¯å¤„ç†ä¸­é—´ä»¶å¿…é¡»æœ‰ 4 ä¸ªå‚æ•°
app.use((err, req, res, next) => {
  console.error(err.stack)
  res.status(500).send('Something broke!')
})
```

### 4. å†…ç½®ä¸­é—´ä»¶

```js
// é™æ€æ–‡ä»¶æœåŠ¡
app.use(express.static('public'))

// JSON è§£æ
app.use(express.json())

// URL ç¼–ç è§£æ
app.use(express.urlencoded({ extended: true }))
```

### 5. ç¬¬ä¸‰æ–¹ä¸­é—´ä»¶

```js
const cors = require('cors')
const morgan = require('morgan')
const helmet = require('helmet')

app.use(cors())
app.use(morgan('combined'))
app.use(helmet())
```

## ğŸ› ï¸ è‡ªå®šä¹‰ä¸­é—´ä»¶å®æˆ˜

### 1. è¯·æ±‚æ—¥å¿—ä¸­é—´ä»¶

```js
const requestLogger = (req, res, next) => {
  const start = Date.now()
  
  res.on('finish', () => {
    const duration = Date.now() - start
    console.log(`${req.method} ${req.url} - ${res.statusCode} - ${duration}ms`)
  })
  
  next()
}

app.use(requestLogger)
```

### 2. èº«ä»½éªŒè¯ä¸­é—´ä»¶

```js
const authenticate = (req, res, next) => {
  const token = req.headers.authorization?.split(' ')[1]
  
  if (!token) {
    return res.status(401).json({ error: 'No token provided' })
  }
  
  try {
    const decoded = jwt.verify(token, process.env.JWT_SECRET)
    req.user = decoded
    next()
  } catch (error) {
    res.status(401).json({ error: 'Invalid token' })
  }
}

// ä¿æŠ¤è·¯ç”±
app.get('/protected', authenticate, (req, res) => {
  res.json({ message: 'Protected data', user: req.user })
})
```

### 3. ç¼“å­˜ä¸­é—´ä»¶

```js
const cache = new Map()

const cacheMiddleware = (duration = 300) => {
  return (req, res, next) => {
    const key = req.originalUrl
    const cached = cache.get(key)
    
    if (cached && Date.now() - cached.timestamp < duration * 1000) {
      return res.json(cached.data)
    }
    
    // é‡å†™ res.json æ–¹æ³•
    const originalJson = res.json
    res.json = function(data) {
      cache.set(key, {
        data,
        timestamp: Date.now()
      })
      originalJson.call(this, data)
    }
    
    next()
  }
}

app.get('/api/data', cacheMiddleware(600), (req, res) => {
  // æ¨¡æ‹Ÿæ•°æ®åº“æŸ¥è¯¢
  const data = { message: 'Expensive operation result' }
  res.json(data)
})
```

## ğŸ” æºç åˆ†æ

Express ä¸­é—´ä»¶çš„æ ¸å¿ƒå®ç°åœ¨ `Layer` ç±»ä¸­ï¼š

```js
// ç®€åŒ–ç‰ˆçš„ Layer å®ç°
class Layer {
  constructor(path, fn) {
    this.path = path
    this.handle = fn
  }
  
  match(path) {
    return this.path === path || this.path === '*'
  }
  
  handleRequest(req, res, next) {
    try {
      this.handle(req, res, next)
    } catch (err) {
      next(err)
    }
  }
}

// ç®€åŒ–ç‰ˆçš„ Router å®ç°
class Router {
  constructor() {
    this.stack = []
  }
  
  use(path, fn) {
    if (typeof path === 'function') {
      fn = path
      path = '*'
    }
    
    const layer = new Layer(path, fn)
    this.stack.push(layer)
  }
  
  handle(req, res, out) {
    let idx = 0
    
    const next = (err) => {
      if (idx >= this.stack.length) {
        return out(err)
      }
      
      const layer = this.stack[idx++]
      
      if (!layer.match(req.path)) {
        return next(err)
      }
      
      if (err) {
        // é”™è¯¯å¤„ç†ä¸­é—´ä»¶
        if (layer.handle.length === 4) {
          layer.handle(err, req, res, next)
        } else {
          next(err)
        }
      } else {
        // æ™®é€šä¸­é—´ä»¶
        if (layer.handle.length < 4) {
          layer.handleRequest(req, res, next)
        } else {
          next()
        }
      }
    }
    
    next()
  }
}
```

## âš¡ æ€§èƒ½ä¼˜åŒ–

### 1. ä¸­é—´ä»¶é¡ºåºä¼˜åŒ–

```js
// âŒ ä½æ•ˆçš„é¡ºåº
app.use(heavyMiddleware)
app.use('/api', apiRouter)
app.use(express.static('public'))

// âœ… ä¼˜åŒ–çš„é¡ºåº
app.use(express.static('public'))  // é™æ€æ–‡ä»¶ä¼˜å…ˆ
app.use('/api', apiRouter)         // API è·¯ç”±
app.use(heavyMiddleware)           // é‡å‹ä¸­é—´ä»¶æ”¾åé¢
```

### 2. æ¡ä»¶æ€§ä¸­é—´ä»¶

```js
// åªåœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨å‹ç¼©
if (process.env.NODE_ENV === 'production') {
  app.use(compression())
}

// åªåœ¨å¼€å‘ç¯å¢ƒä½¿ç”¨è¯¦ç»†æ—¥å¿—
if (process.env.NODE_ENV === 'development') {
  app.use(morgan('dev'))
}
```

### 3. å¼‚æ­¥ä¸­é—´ä»¶ä¼˜åŒ–

```js
// âŒ é˜»å¡å¼å¼‚æ­¥æ“ä½œ
app.use(async (req, res, next) => {
  try {
    const result = await heavyAsyncOperation()
    req.result = result
    next()
  } catch (error) {
    next(error)
  }
})

// âœ… éé˜»å¡å¼å¼‚æ­¥æ“ä½œ
app.use((req, res, next) => {
  // å°†å¼‚æ­¥æ“ä½œæ¨è¿Ÿåˆ°éœ€è¦æ—¶æ‰§è¡Œ
  req.getResult = () => heavyAsyncOperation()
  next()
})
```

## ğŸš¨ å¸¸è§é™·é˜±

### 1. å¿˜è®°è°ƒç”¨ next()

```js
// âŒ é”™è¯¯ï¼šæ²¡æœ‰è°ƒç”¨ next()
app.use((req, res, next) => {
  console.log('Middleware executed')
  // è¯·æ±‚è¢«å¡ä½ï¼Œä¸ä¼šç»§ç»­æ‰§è¡Œ
})

// âœ… æ­£ç¡®ï¼šè°ƒç”¨ next()
app.use((req, res, next) => {
  console.log('Middleware executed')
  next()
})
```

### 2. é”™è¯¯å¤„ç†é¡ºåº

```js
// âŒ é”™è¯¯ï¼šé”™è¯¯å¤„ç†ä¸­é—´ä»¶æ”¾åœ¨å‰é¢
app.use((err, req, res, next) => {
  res.status(500).send('Error')
})

app.get('/', (req, res) => {
  throw new Error('Something went wrong')
})

// âœ… æ­£ç¡®ï¼šé”™è¯¯å¤„ç†ä¸­é—´ä»¶æ”¾åœ¨æœ€å
app.get('/', (req, res) => {
  throw new Error('Something went wrong')
})

app.use((err, req, res, next) => {
  res.status(500).send('Error')
})
```

## ğŸ“ æ€»ç»“

Express ä¸­é—´ä»¶æœºåˆ¶æä¾›äº†å¼ºå¤§è€Œçµæ´»çš„è¯·æ±‚å¤„ç†èƒ½åŠ›ï¼š

1. **æ¨¡å—åŒ–**ï¼šå°†åº”ç”¨é€»è¾‘åˆ†è§£ä¸ºå¯å¤ç”¨çš„ä¸­é—´ä»¶
2. **å¯ç»„åˆ**ï¼šé€šè¿‡ç»„åˆä¸åŒä¸­é—´ä»¶æ„å»ºå¤æ‚åŠŸèƒ½
3. **å¯æ‰©å±•**ï¼šæ˜“äºæ·»åŠ æ–°çš„åŠŸèƒ½æ¨¡å—
4. **å¯æµ‹è¯•**ï¼šæ¯ä¸ªä¸­é—´ä»¶éƒ½å¯ä»¥ç‹¬ç«‹æµ‹è¯•

æŒæ¡ä¸­é—´ä»¶æœºåˆ¶æ˜¯ Express å¼€å‘çš„åŸºç¡€ï¼Œåˆç†ä½¿ç”¨ä¸­é—´ä»¶èƒ½å¤Ÿæ˜¾è‘—æé«˜ä»£ç çš„å¯ç»´æŠ¤æ€§å’Œå¯æ‰©å±•æ€§ã€‚

---

// docs/devops/docker/container-optimization.md - Docker ä¼˜åŒ–ç¤ºä¾‹æ–‡ç« 
---
title: Docker å®¹å™¨æ€§èƒ½ä¼˜åŒ–å®è·µ
date: 2024-01-10
author: Virginia
category: devops
tags: [Docker, æ€§èƒ½ä¼˜åŒ–, å®¹å™¨åŒ–]
description: åˆ†äº«åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä¼˜åŒ– Docker å®¹å™¨æ€§èƒ½çš„å®ç”¨æŠ€å·§å’Œæœ€ä½³å®è·µ
---

# Docker å®¹å™¨æ€§èƒ½ä¼˜åŒ–å®è·µ

åœ¨ç”Ÿäº§ç¯å¢ƒä¸­è¿è¡Œå®¹å™¨åŒ–åº”ç”¨æ—¶ï¼Œæ€§èƒ½ä¼˜åŒ–æ˜¯ä¸€ä¸ªä¸å¯å¿½è§†çš„é‡è¦ç¯èŠ‚ã€‚æœ¬æ–‡å°†åˆ†äº«ä¸€äº›å®ç”¨çš„ Docker å®¹å™¨æ€§èƒ½ä¼˜åŒ–æŠ€å·§ã€‚

## ğŸš€ é•œåƒæ„å»ºä¼˜åŒ–

### 1. å¤šé˜¶æ®µæ„å»º

```dockerfile
# âŒ å•é˜¶æ®µæ„å»º - é•œåƒä½“ç§¯å¤§
FROM node:16
WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
RUN npm run build
EXPOSE 3000
CMD ["npm", "start"]

# âœ… å¤šé˜¶æ®µæ„å»º - é•œåƒä½“ç§¯å°
# æ„å»ºé˜¶æ®µ
FROM node:16-alpine AS builder
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production

# ç”Ÿäº§é˜¶æ®µ
FROM node:16-alpine AS production
WORKDIR /app
COPY --from=builder /app/node_modules ./node_modules
COPY . .
RUN npm run build
EXPOSE 3000
CMD ["npm", "start"]
```

### 2. é€‰æ‹©åˆé€‚çš„åŸºç¡€é•œåƒ

```dockerfile
# âŒ ä½“ç§¯å¤§çš„åŸºç¡€é•œåƒ
FROM ubuntu:20.04

# âœ… è½»é‡çº§çš„ Alpine é•œåƒ
FROM node:16-alpine

# âœ… Distroless é•œåƒï¼ˆæ›´å®‰å…¨ï¼‰
FROM gcr.io/distroless/nodejs16
```

### 3. ä¼˜åŒ–å±‚ç¼“å­˜

```dockerfile
# âŒ ä½æ•ˆçš„å±‚æ„å»º
FROM node:16-alpine
WORKDIR /app
COPY . .
RUN npm install

# âœ… ä¼˜åŒ–çš„å±‚æ„å»º
FROM node:16-alpine
WORKDIR /app
# å…ˆå¤åˆ¶ä¾èµ–æ–‡ä»¶ï¼Œåˆ©ç”¨ç¼“å­˜
COPY package*.json ./
RUN npm ci --only=production
# å†å¤åˆ¶æºä»£ç 
COPY . .
```

## ğŸ’¾ èµ„æºé™åˆ¶é…ç½®

### 1. å†…å­˜é™åˆ¶

```bash
# é™åˆ¶å®¹å™¨å†…å­˜ä½¿ç”¨
docker run -m 512m myapp

# åœ¨ docker-compose.yml ä¸­é…ç½®
services:
  app:
    image: myapp
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
```

### 2. CPU é™åˆ¶

```bash
# é™åˆ¶ CPU ä½¿ç”¨
docker run --cpus="1.5" myapp

# åœ¨ docker-compose.yml ä¸­é…ç½®
services:
  app:
    image: myapp
    deploy:
      resources:
        limits:
          cpus: '1.5'
        reservations:
          cpus: '0.5'
```

### 3. ç›‘æ§èµ„æºä½¿ç”¨

```bash
# å®æ—¶ç›‘æ§å®¹å™¨èµ„æºä½¿ç”¨
docker stats

# æŸ¥çœ‹å®¹å™¨è¯¦ç»†ä¿¡æ¯
docker inspect <container_id>
```

## ğŸ”§ è¿è¡Œæ—¶ä¼˜åŒ–

### 1. å¥åº·æ£€æŸ¥

```dockerfile
# åœ¨ Dockerfile ä¸­æ·»åŠ å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD curl -f http://localhost:3000/health || exit 1
```

```yaml
# åœ¨ docker-compose.yml ä¸­é…ç½®
services:
  app:
    image: myapp
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
```

### 2. æ—¥å¿—ç®¡ç†

```bash
# é™åˆ¶æ—¥å¿—æ–‡ä»¶å¤§å°
docker run --log-driver json-file --log-opt max-size=10m --log-opt max-file=3 myapp
```

```yaml
# åœ¨ docker-compose.yml ä¸­é…ç½®
services:
  app:
    image: myapp
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
```

### 3. å®‰å…¨ä¼˜åŒ–

```dockerfile
# åˆ›å»ºé root ç”¨æˆ·
RUN addgroup -g 1001 -S nodejs
RUN adduser -S nextjs -u 1001
USER nextjs

# æˆ–è€…ä½¿ç”¨ç°æœ‰çš„é root ç”¨æˆ·
USER node
```

## ğŸ“Š å­˜å‚¨ä¼˜åŒ–

### 1. ä½¿ç”¨ .dockerignore

```
# .dockerignore
node_modules
npm-debug.log
.git
.gitignore
README.md
.env
coverage
.nyc_output
```

### 2. å·æŒ‚è½½ä¼˜åŒ–

```yaml
# ä½¿ç”¨å‘½åå·è€Œä¸æ˜¯ç»‘å®šæŒ‚è½½
services:
  db:
    image: postgres:13
    volumes:
      - postgres_data:/var/lib/postgresql/data  # å‘½åå·
    environment:
      POSTGRES_DB: myapp

volumes:
  postgres_data:
```

### 3. å¤šé˜¶æ®µæ„å»ºæ¸…ç†

```dockerfile
FROM node:16-alpine AS builder
WORKDIR /app
COPY package*.json ./
RUN npm ci
COPY . .
RUN npm run build

FROM nginx:alpine
# åªå¤åˆ¶æ„å»ºç»“æœï¼Œä¸åŒ…å«æºä»£ç å’Œä¾èµ–
COPY --from=builder /app/dist /usr/share/nginx/html
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```

## ğŸŒ ç½‘ç»œä¼˜åŒ–

### 1. ä½¿ç”¨è‡ªå®šä¹‰ç½‘ç»œ

```yaml
# docker-compose.yml
version: '3.8'
services:
  app:
    image: myapp
    networks:
      - app-network
  
  db:
    image: postgres:13
    networks:
      - app-network

networks:
  app-network:
    driver: bridge
```

### 2. å®¹å™¨é—´é€šä¿¡ä¼˜åŒ–

```yaml
# ä½¿ç”¨å†…éƒ¨ç½‘ç»œï¼Œä¸æš´éœ²ä¸å¿…è¦çš„ç«¯å£
services:
  app:
    image: myapp
    ports:
      - "3000:3000"  # åªæš´éœ²åº”ç”¨ç«¯å£
    depends_on:
      - db
  
  db:
    image: postgres:13
    # ä¸æš´éœ²æ•°æ®åº“ç«¯å£åˆ°å®¿ä¸»æœº
    environment:
      POSTGRES_DB: myapp
```

## ğŸ” ç›‘æ§å’Œè°ƒè¯•

### 1. æ€§èƒ½ç›‘æ§

```bash
# ä½¿ç”¨ cAdvisor ç›‘æ§å®¹å™¨æ€§èƒ½
docker run \
  --volume=/:/rootfs:ro \
  --volume=/var/run:/var/run:ro \
  --volume=/sys:/sys:ro \
  --volume=/var/lib/docker/:/var/lib/docker:ro \
  --volume=/dev/disk/:/dev/disk:ro \
  --publish=8080:8080 \
  --detach=true \
  --name=cadvisor \
  gcr.io/cadvisor/cadvisor:latest
```

### 2. åº”ç”¨æ€§èƒ½åˆ†æ

```javascript
// Node.js åº”ç”¨ä¸­æ·»åŠ æ€§èƒ½ç›‘æ§
const prometheus = require('prom-client')

// åˆ›å»ºæ€§èƒ½æŒ‡æ ‡
const httpDuration = new prometheus.Histogram({
  name: 'http_request_duration_ms',
  help: 'Duration of HTTP requests in ms',
  labelNames: ['route', 'method', 'status_code']
})

// ä¸­é—´ä»¶è®°å½•è¯·æ±‚æ—¶é—´
app.use((req, res, next) => {
  const start = Date.now()
  
  res.on('finish', () => {
    const duration = Date.now() - start
    httpDuration
      .labels(req.route?.path || req.path, req.method, res.statusCode)
      .observe(duration)
  })
  
  next()
})
```

### 3. å®¹å™¨è°ƒè¯•

```bash
# è¿›å…¥è¿è¡Œä¸­çš„å®¹å™¨
docker exec -it <container_id> sh

# æŸ¥çœ‹å®¹å™¨æ—¥å¿—
docker logs -f <container_id>

# å¤åˆ¶æ–‡ä»¶åˆ°å®¹å™¨
docker cp localfile.txt <container_id>:/path/to/file

# æŸ¥çœ‹å®¹å™¨è¿›ç¨‹
docker top <container_id>
```

## ğŸš€ ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ

### 1. å®¹å™¨ç¼–æ’

```yaml
# Kubernetes Deployment ç¤ºä¾‹
apiVersion: apps/v1
kind: Deployment
metadata:
  name: myapp
spec:
  replicas: 3
  selector:
    matchLabels:
      app: myapp
  template:
    metadata:
      labels:
        app: myapp
    spec:
      containers:
      - name: myapp
        image: myapp:latest
        resources:
          requests:
            memory: "256Mi"
            cpu: "250m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        readinessProbe:
          httpGet:
            path: /health
            port: 3000
          initialDelaySeconds: 10
          periodSeconds: 5
        livenessProbe:
          httpGet:
            path: /health
            port: 3000
          initialDelaySeconds: 30
          periodSeconds: 10
```

### 2. å®¹å™¨å®‰å…¨æ‰«æ

```bash
# ä½¿ç”¨ Trivy æ‰«æé•œåƒæ¼æ´
docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
  aquasec/trivy image myapp:latest

# ä½¿ç”¨ Clair è¿›è¡Œå®‰å…¨æ‰«æ
docker run -d --name clair-db arminc/clair-db:latest
docker run -p 6060:6060 --link clair-db:postgres -d --name clair arminc/clair-local-scan:latest
```

## ğŸ“ˆ æ€§èƒ½æµ‹è¯•

### 1. å‹åŠ›æµ‹è¯•

```bash
# ä½¿ç”¨ Apache Bench
ab -n 1000 -c 10 http://localhost:3000/

# ä½¿ç”¨ wrk
wrk -t12 -c400 -d30s http://localhost:3000/

# ä½¿ç”¨ hey
hey -n 1000 -c 50 http://localhost:3000/
```

### 2. å®¹å™¨æ€§èƒ½åŸºå‡†æµ‹è¯•

```dockerfile
# åˆ›å»ºæ€§èƒ½æµ‹è¯•é•œåƒ
FROM alpine:latest

RUN apk add --no-cache \
    sysbench \
    iperf3 \
    fio

# CPU æµ‹è¯•
RUN sysbench cpu --cpu-max-prime=20000 run

# å†…å­˜æµ‹è¯•
RUN sysbench memory --memory-total-size=1G run

# ç£ç›˜ I/O æµ‹è¯•
RUN fio --name=random-write --ioengine=posixaio --rw=randwrite --bs=4k --size=4g --numjobs=1 --iodepth=1 --runtime=60 --time_based --end_fsync=1
```

## ğŸ“ æ€»ç»“

Docker å®¹å™¨æ€§èƒ½ä¼˜åŒ–æ˜¯ä¸€ä¸ªå¤šæ–¹é¢çš„å·¥ç¨‹ï¼š

### ğŸ¯ å…³é”®ä¼˜åŒ–ç‚¹
1. **é•œåƒä¼˜åŒ–**ï¼šä½¿ç”¨å¤šé˜¶æ®µæ„å»ºï¼Œé€‰æ‹©è½»é‡çº§åŸºç¡€é•œåƒ
2. **èµ„æºç®¡ç†**ï¼šåˆç†è®¾ç½®å†…å­˜å’Œ CPU é™åˆ¶
3. **å­˜å‚¨ä¼˜åŒ–**ï¼šä½¿ç”¨ .dockerignoreï¼Œä¼˜åŒ–å±‚ç¼“å­˜
4. **ç½‘ç»œé…ç½®**ï¼šä½¿ç”¨è‡ªå®šä¹‰ç½‘ç»œï¼Œä¼˜åŒ–å®¹å™¨é—´é€šä¿¡
5. **ç›‘æ§è°ƒè¯•**ï¼šå»ºç«‹å®Œå–„çš„ç›‘æ§ä½“ç³»

### ğŸ”§ æœ€ä½³å®è·µ
- åœ¨å¼€å‘é˜¶æ®µå°±è€ƒè™‘æ€§èƒ½ä¼˜åŒ–
- å®šæœŸè¿›è¡Œæ€§èƒ½æµ‹è¯•å’Œç›‘æ§
- ä¿æŒé•œåƒçš„æœ€å°åŒ–åŸåˆ™
- åˆç†é…ç½®å¥åº·æ£€æŸ¥å’Œèµ„æºé™åˆ¶
- å»ºç«‹å®Œå–„çš„æ—¥å¿—å’Œç›‘æ§ç³»ç»Ÿ

é€šè¿‡è¿™äº›ä¼˜åŒ–å®è·µï¼Œå¯ä»¥æ˜¾è‘—æå‡ Docker å®¹å™¨åœ¨ç”Ÿäº§ç¯å¢ƒä¸­çš„æ€§èƒ½è¡¨ç°ã€‚

---

*å¸Œæœ›è¿™äº›ä¼˜åŒ–æŠ€å·§èƒ½å¸®åŠ©ä½ æ„å»ºæ›´é«˜æ•ˆçš„å®¹å™¨åŒ–åº”ç”¨ï¼*