'use strict';

var Vue = require('vue');
var index = require('../helper/dist/index.js');
var useScopeDispose = require('./useScopeDispose.js');

const callBsz = (url = "//busuanzi.ibruce.info/busuanzi?jsonpCallback=BusuanziCallback") => {
  const jsonpCallback = "BusuanziCallback_" + Math.floor(1099511627776 * Math.random());
  url = url.replace("=BusuanziCallback", "=" + jsonpCallback);
  const scriptDom = document.createElement("script");
  scriptDom.type = "text/javascript";
  scriptDom.defer = true;
  scriptDom.src = url;
  document.body.appendChild(scriptDom);
  let response;
  window[jsonpCallback] = (data) => response = data;
  return new Promise((resolve, reject) => {
    scriptDom.onload = () => {
      resolve(response);
      setTimeout(() => {
        document.body.removeChild(scriptDom);
      }, 10);
    };
    scriptDom.onerror = () => reject("Error Loading " + url);
  });
};
const useBuSuanZi = (immediate = false, options = {}) => {
  const { url, tryRequest = false, tryCount = 5, tryIterationTime = 2e3 } = options;
  const sitePv = Vue.ref(0);
  const siteUv = Vue.ref(0);
  const pagePv = Vue.ref(0);
  const isGet = Vue.ref(null);
  const request = () => {
    if (!index.isClient) return;
    if (isGet.value === false) return;
    isGet.value = false;
    callBsz(url).then((data) => {
      sitePv.value = data.site_pv || 9999;
      siteUv.value = data.site_uv || 9999;
      pagePv.value = data.page_pv || 9999;
      isGet.value = true;
    });
  };
  if (immediate) request();
  if (tryRequest) {
    let i = 0;
    const clearTimer = (timer2) => {
      if (timer2) {
        clearInterval(timer2);
        timer2 = null;
      }
    };
    const timer = setInterval(() => {
      if (isGet.value) return clearTimer(timer);
      request();
      i += tryIterationTime;
      if (i > tryIterationTime * tryCount) clearTimer(timer);
    }, tryIterationTime);
    useScopeDispose.useScopeDispose(() => clearTimer(timer));
  }
  return { sitePv, siteUv, pagePv, isGet, request };
};

exports.useBuSuanZi = useBuSuanZi;
